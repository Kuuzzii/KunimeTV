<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watch - KuNime</title>
  <style>
    /* Your existing CSS (shortened here for brevity, replace with your full CSS) */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    body {
      background-color: #111;
      color: #fff;
      line-height: 1.5;
    }
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background-color: #000;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { /* ... */ }
    .back-button {
      padding: 8px 16px;
      background-color: #e60000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .back-button:hover {
      background-color: #cc0000;
    }
    .movie-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    .movie-backdrop {
      position: relative;
      padding: 25px 0;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .movie-backdrop::before {
      content: '';
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1;
    }
    .movie-details {
      position: relative;
      z-index: 2;
      display: flex;
      gap: 25px;
      padding: 0 20px;
    }
    .movie-poster {
      flex-shrink: 0;
      width: 220px;
      height: 330px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .movie-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .movie-info {
      flex-grow: 1;
    }
    .movie-info h1 {
      font-size: 28px;
      margin-bottom: 10px;
      color: #fff;
    }
    .movie-meta {
      color: #ccc;
      margin-bottom: 15px;
    }
    .movie-genres {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }
    .movie-genres span {
      background-color: rgba(255,255,255,0.1);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 14px;
    }
    #movie-overview {
      color: #ddd;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    .movie-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-start;
    }
    .action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
    }
    .play-btn {
      background-color: #e60000;
      color: white;
    }
    #server-select {
      background-color: #333;
      color: white;
      padding: 10px 15px;
    }
    .warning-box {
      margin-top: 15px;
      padding: 12px 16px;
      background-color: #ff9800;
      color: #000;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 4px;
      user-select: none;
      max-width: 600px;
      width: 100%;
      box-sizing: border-box;
    }
    .video-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.25%;
      margin-bottom: 30px;
      background-color: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    #movie-video {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: #000;
    }
    /* Responsive styles (omit here for brevity - use yours) */
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo">
      <img src="https://static.vecteezy.com/system/resources/previews/016/699/663/original/graffiti-letter-k-premium-illustration-vector.jpg" alt="KuNime Logo" />
      <span>KuNime</span>
    </div>
    <button id="back-btn" class="back-button">&#8592; Back to Homepage</button>
  </header>

  <main class="movie-container">
    <div id="movie-backdrop" class="movie-backdrop">
      <div class="movie-details">
        <div class="movie-poster">
          <img id="movie-poster" src="" alt="Movie Poster" />
        </div>
        <div class="movie-info">
          <h1 id="movie-title"></h1>
          <p class="movie-meta">
            <span id="movie-release-date"></span> •
            <span id="movie-runtime"></span>
          </p>
          <div id="movie-genres" class="movie-genres"></div>
          <p id="movie-overview"></p>
          <div class="movie-actions">
            <button id="play-btn" class="action-btn play-btn">&#9658; Play</button>
            <select id="server-select" class="action-btn" aria-label="Select Streaming Server"></select>
            <div class="warning-box" role="alert" aria-live="polite">
              ⚠️Some servers may occasionally be unavailable. If the one you selected is not working, please try another. For the best experience, we recommend choosing one of the first four servers listed
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="video-container">
      <iframe id="movie-video" frameborder="0" allowfullscreen loading="lazy" title="Streaming Video Player"></iframe>
    </div>
  </main>

  <script>
    const API_KEY = 'b139bc417606842811f1526ae92572bc';
    const BASE_URL = 'https://api.themoviedb.org/3';
    const IMG_URL = 'https://image.tmdb.org/t/p/original';

    const urlParams = new URLSearchParams(window.location.search);
    const movieId = urlParams.get('id');
    const type = urlParams.get('type'); // movie or tv
    const season = urlParams.get('season') || 1;
    const episode = urlParams.get('episode') || 1;

    const backdrop = document.getElementById('movie-backdrop');
    const poster = document.getElementById('movie-poster');
    const titleEl = document.getElementById('movie-title');
    const releaseDateEl = document.getElementById('movie-release-date');
    const runtimeEl = document.getElementById('movie-runtime');
    const genresEl = document.getElementById('movie-genres');
    const overviewEl = document.getElementById('movie-overview');
    const videoIframe = document.getElementById('movie-video');
    const playBtn = document.getElementById('play-btn');
    const serverSelect = document.getElementById('server-select');
    const backBtn = document.getElementById('back-btn');

    let currentServerIndex = null;
    const servers = [];
    let imdbId = null;

    async function getImdbId(tmdbId, mediaType) {
      if (!tmdbId || !mediaType) return null;
      try {
        const url = `${BASE_URL}/${mediaType}/${tmdbId}?api_key=${API_KEY}&append_to_response=external_ids`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch external IDs');
        const data = await res.json();
        return (data.external_ids && data.external_ids.imdb_id) || null;
      } catch (err) {
        console.error('Error getting IMDb ID:', err);
        return null;
      }
    }

    async function fetchDetails() {
      try {
        const res = await fetch(`${BASE_URL}/${type}/${movieId}?api_key=${API_KEY}`);
        if (!res.ok) throw new Error('Failed to fetch details');
        const data = await res.json();

        backdrop.style.backgroundImage = `url(${IMG_URL}${data.backdrop_path || ''})`;
        poster.src = `${IMG_URL}${data.poster_path || ''}`;
        titleEl.textContent = data.title || data.name || '';
        overviewEl.textContent = data.overview || 'No description available.';
        releaseDateEl.textContent = new Date(data.release_date || data.first_air_date || '').toLocaleDateString();

        if (type === 'movie') {
          runtimeEl.textContent = data.runtime ? `${data.runtime} min` : '';
        } else {
          runtimeEl.textContent = data.episode_run_time && data.episode_run_time.length > 0 ? `${data.episode_run_time[0]} min per episode` : '';
        }

        genresEl.innerHTML = '';
        if (data.genres) {
          data.genres.forEach(genre => {
            const span = document.createElement('span');
            span.className = 'genre-tag';
            span.textContent = genre.name;
            genresEl.appendChild(span);
          });
        }
      } catch (err) {
        console.error('Error fetching details:', err);
        alert('Failed to load movie/show details.');
      }
    }

    async function setupServers() {
      imdbId = type === 'tv' ? await getImdbId(movieId, 'tv') : movieId;
      servers.length = 0;

      if (type === 'movie') {
        servers.push(
          { name: 'Server 1', url: `https://fsapi.xyz/movie/${movieId}` },
          { name: 'Server  2', url: `https://vidsrc.me/embed/${movieId}` },
          { name: 'Server 3', url: `https://curtstream.com/movies/imdb/${movieId}` },
          { name: 'Server 4', url: `https://moviewp.com/se.php?video_id=${movieId}` },
          { name: 'Server 5', url: `https://v2.apimdb.net/e/movie/${movieId}` },
          { name: 'Server 6', url: `https://gomo.to/movie/${movieId}` },
          { name: 'Server 8', url: `https://vidcloud.stream/${movieId}.html` },
          { name: 'Server 9', url: `https://vidlink.pro/movie/${movieId}` },
          { name: 'Server 10', url: `https://vidsrc.dev/embed/movie/${movieId}` },
          { name: 'Server 11', url: `https://111movies.com/movie/${movieId}` },
          { name: 'Server 12', url: `https://vidjoy.pro/embed/movie/${movieId}` },
          { name: 'Server 13', url: `https://vidsrc.io/embed/movie/${movieId}` },
          { name: 'Server 14', url: `https://vidsrc.cc/v2/embed/movie/${movieId}` },
          { name: 'Server 15', url: `https://vidsrc.xyz/embed/movie/${movieId}` },
          { name: 'Server 16', url: `https://www.2embed.cc/embed/${movieId}` },
          { name: 'Server 17', url: `https://moviesapi.club/movie/${movieId}` }
        );
      } else if (type === 'tv') {
        if (!imdbId) {
          alert('IMDb ID not found for TV show. Some streams may not work.');
        }
        servers.push(
          { name: 'Server 1', url: `https://vidsrc.me/embed/tv/${movieId}/${season}/${episode}` },
          { name: 'Server  2', url: `https://vidsrc.me/embed/${movieId}` },
          { name: 'Server 3', url: `https://fsapi.xyz/tv/${movieId}/${season}/${episode}` },
          { name: 'Server 4', url: `https://fsapi.xyz/tv-imdb/${imdbId || ''}-${season}-${episode}` },
          { name: 'Server 5', url: `https://moviewp.com/se.php?tmdb=${movieId}&s=${season}&e=${episode}` },
          { name: 'Server 6', url: `https://v2.apimdb.net/e/tmdb/tv/${movieId}/${season}/${episode}/` },
          { name: 'Server 7', url: `https://databasegdriveplayer.co/player.php?type=series&tmdb=${movieId}&season=${season}&episode=${episode}` },
          { name: 'Server 8', url: `https://curtstream.com/series/tmdb/${movieId}/season/${season}/episode/${episode}/` }
        );
      }

      // Log servers for debugging
      console.log('Available servers:', servers.map(s => s.name));

      // Populate server dropdown
      serverSelect.innerHTML = '';
      servers.forEach((server, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = server.name;
        serverSelect.appendChild(option);
      });

      currentServerIndex = null;
      updateVideoSrc();
    }

    function updateVideoSrc() {
      const existingMsg = document.getElementById('choose-server-msg');
      if (existingMsg) existingMsg.remove();

      if (currentServerIndex === null) {
        videoIframe.src = 'about:blank';

        const msg = document.createElement('div');
        msg.id = 'choose-server-msg';
        msg.style =
          'position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;background-color:rgba(0,0,0,0.75);font-size:1.4rem;z-index:10;';
        msg.textContent = '⚠️ Please choose a streaming server first';

        const container = document.querySelector('.video-container');
        container.style.position = 'relative';
        container.appendChild(msg);

        playBtn.disabled = true;
        return;
      }

      playBtn.disabled = false;
      videoIframe.src = servers[currentServerIndex].url;
    }

    serverSelect.addEventListener('change', (e) => {
      currentServerIndex = parseInt(e.target.value, 10);
      updateVideoSrc();
    });

    playBtn.addEventListener('click', () => {
      if (currentServerIndex === null) {
        alert('Please choose a streaming server first.');
        return;
      }
      document.querySelector('.video-container').scrollIntoView({ behavior: 'smooth' });
    });

    backBtn.addEventListener('click', () => window.history.back());

    if (!movieId || !type) {
      alert('Invalid movie or TV show ID');
      playBtn.disabled = true;
    } else {
      fetchDetails();
      setupServers();
      updateVideoSrc();
    }
  </script>
</body>
</html>
